sudo: required

language: generic

env:
  global:
    - APP_NAME=travistest
    - DOCKER_HUB_NAME=${DOCKER_USERNAME}/${APP_NAME}
    - IMAGE_NAME=${DOCKER_HUB_NAME}:${TRAVIS_BRANCH}
    - IMAGE_NAME_TEST=${IMAGE_NAME}-test
    - REGEX_PUSH_BRANCH='development|staging|master'
    - REGEX_PUSH_BRANCH2=/($REGEX_PUSH_BRANCH)/
    - REGEX_PUSH_BRANCH3=/(development|staging|master)/
    - REGEX_PUSH_BRANCH4=/test/
    - REGEX_BRANCH_CI='/^([0-9A-Za-z][0-9A-Za-z.-]+)_([0-9A-Za-z.-]+)_(development|staging|master)$/'
    - REGEX_BRANCH_CI2='^([0-9A-Za-z][0-9A-Za-z.-]+)_([0-9A-Za-z.-]+)_(development|staging|master)$'
    - REGEX_DEPLOY_BRANCH='staging|master'
#    - BRANCH_VERSION=''
#    - BRANCH_APP=''
#    - BRANCH_STAGE=''

branches:
  only:
    - /^([0-9A-Za-z][0-9A-Za-z.-]+)_([0-9A-Za-z.-]+)_(development|staging|master)$/

stages:
  - build
  - test
  - name: deploy
    if: branch =~ /(development|staging|master)$/

jobs:
  include:
    - stage: build
      script:
        - echo ">>> BUILDING STARTED <<<<"
        - docker pull ${IMAGE_NAME} || true
        - docker images
        - docker build -t ${IMAGE_NAME_TEST} .
        - docker images
        - echo "${DOCKER_PASSWORD}" | docker login --username "${DOCKER_USERNAME}" --password-stdin
        - docker push ${IMAGE_NAME_TEST}
        - echo ">>> BUILDING FINISHED <<<<"
    - stage: deploy
      script:
        - echo ">>> Deploy 2 Dockerhub ${TRAVIS_BRANCH} <<<<"
        - docker images
        - if [[ ${TRAVIS_BRANCH} =~ ${REGEX_PUSH_BRANCH} ]]; then
            BRANCH_VERSION=${BASH_REMATCH[1]};
            BRANCH_APP=${BASH_REMATCH[2]};
            BRANCH_STAGE=${BASH_REMATCH[3]};
            env
            docker pull ${IMAGE_NAME_TEST} || true;
            docker tag ${IMAGE_NAME_TEST} ${IMAGE_NAME};
            docker images;
            echo "${DOCKER_PASSWORD}" | docker login --username "${DOCKER_USERNAME}" --password-stdin;
            docker push ${IMAGE_NAME};
          fi
#    - stage: deploy
#      script: skip
#      deploy:
#        provider: releases
#        api_key: "$GITHUB_OAUTH_TOKEN"
#        skip_cleanup: true
#        on:
##          condition: $TRAVIS_BRANCH =~ staging|master
#          tags: true
#
##            docker tag ${IMAGE_NAME_TEST} ${IMAGE_NAME};
##            docker build -t ${IMAGE_NAME} . ;

#services:
#  - docker

#git:
#  depth: 5
#  quiet: true
#  submodules: true

#    - /^([0-9A-Za-z][0-9A-Za-z.-]+)_([0-9A-Za-z.-]+)_(development|staging|master)$/
#  - name: deploy
#    if: branch =~ /(development|staging|master)/
#    if: branch =~ env(REGEX_PUSH_BRANCH4)
#    if: branch =~ /^([0-9A-Za-z][0-9A-Za-z.-]+)_([0-9A-Za-z.-]+)_(development|staging|master)$/
#  - name: deploy
#    if: branch =~ ${REGEX_PUSH_BRANCH}

# para criar um release no github conforme a tag criada no Commit
#    - stage: GitHub Release
#      script: skip
#      deploy:
#        provider: releases
#        api_key: "$GITHUB_OAUTH_TOKEN"
#        skip_cleanup: true
#        on:
#          tags: true

#deploy:
#  on:
#    branch: release
#    condition: $MY_ENV = super_awesome
# ou
#    all_branches: true
#    repo: travis-ci/dpl

#deploy:
#  overwrite: true
#  file: "FILE TO UPLOAD"

#deploy:
#  provider: script
#  script: deploy.sh
#  on:
#    all_branches: true
#    condition: $TRAVIS_BRANCH =~ ^staging|production$


#deploy:
#  # deploy develop to the staging environment
#  - provider: script
#    script: bash scripts/deploy.sh staging $TRAVIS_TAG
#    on:
#      branch: develop
#  # deploy master to production
#  - provider: script
#    script: bash scripts/deploy.sh production $TRAVIS_TAG
#    on:
#      branch: master


#apt addons:
#before_install:
#install:
#before_script:
#script:
#before_cache:
#after_success:
#after_failure:
#before_deploy:
#deploy:
#after_deploy:
#after_script:


######dockerhub

#before_install:
#  - docker build -t cinhtau/elasticsearch .
#script:
#  - docker images cinhtau/elasticsearch
#after_success:
#  - if [ "$TRAVIS_BRANCH" == "master" ]; then
#    docker login -e="$DOCKER_EMAIL" -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD";
#    docker push cinhtau/elasticsearch;
#    fi